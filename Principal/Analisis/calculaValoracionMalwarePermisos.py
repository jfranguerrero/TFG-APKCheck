import sys
from xml.dom.minidom import parseString
from pymongo import MongoClient
import MySQLdb

conn = MySQLdb.connect(host= "localhost",
                  user="root",
                  passwd="M1_m2m3m4",
                  db="apk")

c = conn.cursor()
client = MongoClient()

db = client.aplicaciones

tofind=sys.argv[1]
numerador=0.0
denominador=0.0

roots=db.permisos_totales.find({"HASH": tofind})

for perm in roots:
    for i in perm['permisos']:
        c.execute('SELECT Puntuacion FROM valoraciones WHERE Permiso=%s', (i,))
        data=c.fetchall()
        if len(data)!=0:
            for d in data:
                valor=d[0]
                numerador=numerador+float(valor)
                denominador=denominador+float(valor)
        else:
                denominador=denominador+1

if denominador !=0.0:
    result=float(numerador/denominador)
    c.execute("INSERT INTO puntuaciones (HASH, Puntuacion) VALUES (%s, %s)",(tofind, result))
    conn.commit()


else :
    c.execute("INSERT INTO puntuaciones (HASH, Puntuacion) VALUES (%s, %s)",(tofind, 0))
    conn.commit()

conn.close()
